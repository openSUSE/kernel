// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2025 Josua Mayer <josua@solid-run.com>
 */

#include <dt-bindings/leds/common.h>

/ {
	aliases {
		rtc0 = &carrier_rtc;
		rtc1 = &snvs_rtc;
	};

	leds {
		compatible = "gpio-leds";
		pinctrl-names = "default";
		pinctrl-0 = <&led_pins>;

		led-0 {
			label = "D30";
			color = <LED_COLOR_ID_GREEN>;
			gpios = <&gpio5 28 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};

		led-1 {
			label = "D31";
			color = <LED_COLOR_ID_GREEN>;
			gpios = <&gpio4 24 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};

		led-2 {
			label = "D32";
			color = <LED_COLOR_ID_GREEN>;
			gpios = <&gpio4 23 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};

		led-3 {
			label = "D33";
			color = <LED_COLOR_ID_GREEN>;
			gpios = <&gpio4 21 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};

		led-4 {
			label = "D34";
			color = <LED_COLOR_ID_GREEN>;
			gpios = <&gpio4 22 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};
	};

	rfkill-mpcie-wifi {
		/*
		 * The mpcie connector only has USB,
		 * therefore this rfkill is for cellular radios only.
		 */
		compatible = "rfkill-gpio";
		pinctrl-names = "default";
		pinctrl-0 = <&mpcie_rfkill_pins>;
		label = "mpcie radio";
		radio-type = "wwan";
		/* rfkill-gpio inverts internally */
		shutdown-gpios = <&gpio1 5 GPIO_ACTIVE_HIGH>;
	};

	vmmc: regulator-mmc {
		compatible = "regulator-fixed";
		pinctrl-names = "default";
		pinctrl-0 = <&vmmc_pins>;
		regulator-name = "vmmc";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		gpio = <&gpio2 19 GPIO_ACTIVE_HIGH>;
		startup-delay-us = <250>;
	};

	vbus1: regulator-vbus-1 {
		compatible = "regulator-fixed";
		regulator-name = "vbus1";
		gpio = <&gpio1 14 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		pinctrl-names = "default";
		pinctrl-0 = <&vbus1_pins>;
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
	};

	vbus2: regulator-vbus-2 {
		compatible = "regulator-fixed";
		regulator-name = "vbus2";
		gpio = <&gpio1 15 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		pinctrl-names = "default";
		pinctrl-0 = <&vbus2_pins>;
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
	};

	v_1_2: regulator-1-2 {
		compatible = "regulator-fixed";
		regulator-name = "1v2";
		regulator-min-microvolt = <1200000>;
		regulator-max-microvolt = <1200000>;
	};

	vmpcie {
		/* supplies mpcie and m2 connectors */
		compatible = "regulator-fixed";
		regulator-name = "vmpcie";
		gpio = <&gpio1 10 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		pinctrl-names = "default";
		pinctrl-0 = <&vmpcie_pins>;
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
	};
};

/* mikrobus spi */
&ecspi2 {
	num-cs = <1>;
	pinctrl-names = "default";
	pinctrl-0 = <&mikro_spi_pins>;
	status = "okay";
};

&gpio1 {
	pinctrl-0 = <&mpcie_reset_pins>;
	pinctrl-names = "default";

	mpcie-reset-hog {
		gpio-hog;
		gpios = <1 GPIO_ACTIVE_LOW>;
		output-low;
		line-name = "mpcie-reset";
	};
};

&i2c3 {
	carrier_eeprom: eeprom@57{
		compatible = "st,24c02", "atmel,24c02";
		reg = <0x57>;
		pagesize = <16>;
	};

	carrier_rtc: rtc@69 {
		compatible = "abracon,ab1805";
		reg = <0x69>;
		abracon,tc-diode = "schottky";
		abracon,tc-resistor = <3>;
	};
};

&iomuxc {
	csi_pins: pinctrl-csi-grp {
		fsl,pins = <
			/* Pin 24: STROBE */
			MX8MP_IOMUXC_NAND_DATA01__GPIO3_IO07		0x0
		>;
	};

	led_pins: pinctrl-led-grp {
		fsl,pins = <
			MX8MP_IOMUXC_SAI2_RXC__GPIO4_IO22		0x0
			MX8MP_IOMUXC_SAI2_RXFS__GPIO4_IO21		0x0
			MX8MP_IOMUXC_SAI2_RXD0__GPIO4_IO23		0x0
			MX8MP_IOMUXC_SAI2_TXFS__GPIO4_IO24		0x0
			MX8MP_IOMUXC_UART4_RXD__GPIO5_IO28		0x0
		>;
	};

	mikro_int_pins: pinctrl-mikro-int-grp {
		fsl,pins = <
			MX8MP_IOMUXC_ECSPI1_SS0__GPIO5_IO09		0x0
		>;
	};

	mikro_pwm_pins: pinctrl-mikro-pwm-grp {
		fsl,pins = <
			MX8MP_IOMUXC_ECSPI1_MISO__GPIO5_IO08		0x0
		>;
	};

	mikro_rst_pins: pinctrl-mikro-rst-grp {
		fsl,pins = <
			MX8MP_IOMUXC_SAI3_RXD__GPIO4_IO30		0x0
		>;
	};

	mikro_spi_pins: pinctrl-mikro-spi-grp {
		fsl,pins = <
			MX8MP_IOMUXC_ECSPI2_SS0__ECSPI2_SS0		0x40000
			MX8MP_IOMUXC_ECSPI2_SCLK__ECSPI2_SCLK		0x82
			MX8MP_IOMUXC_ECSPI2_MISO__ECSPI2_MISO		0x82
			MX8MP_IOMUXC_ECSPI2_MOSI__ECSPI2_MOSI		0x82
		>;
	};

	mikro_uart_pins: pinctrl-mikro-uart-grp {
		fsl,pins = <
			MX8MP_IOMUXC_ECSPI1_SCLK__UART3_DCE_RX		0x140
			MX8MP_IOMUXC_ECSPI1_MOSI__UART3_DCE_TX		0x140
		>;
	};

	mpcie_reset_pins: pinctrl-mpcie-reset-grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO01__GPIO1_IO01		0x0
		>;
	};

	mpcie_rfkill_pins: pinctrl-pcie-rfkill-grp {
		fsl,pins = <
			/* weak i/o, open drain */
			MX8MP_IOMUXC_GPIO1_IO05__GPIO1_IO05		0x20
		>;
	};

	usb_hub_pins: pinctrl-usb-hub-grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO11__GPIO1_IO11		0x0
		>;
	};

	usdhc2_pins: pinctrl-usdhc2-grp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_CLK__USDHC2_CLK		0x190
			MX8MP_IOMUXC_SD2_CMD__USDHC2_CMD		0x1d0
			MX8MP_IOMUXC_SD2_DATA0__USDHC2_DATA0		0x1d0
			MX8MP_IOMUXC_SD2_DATA1__USDHC2_DATA1		0x1d0
			MX8MP_IOMUXC_SD2_DATA2__USDHC2_DATA2		0x1d0
			MX8MP_IOMUXC_SD2_DATA3__USDHC2_DATA3		0x1d0
			MX8MP_IOMUXC_GPIO1_IO04__USDHC2_VSELECT		0x140
			MX8MP_IOMUXC_SD2_CD_B__USDHC2_CD_B		0x140
		>;
	};

	usdhc2_100mhz_pins: pinctrl-usdhc2-100mhz-grp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_CLK__USDHC2_CLK		0x194
			MX8MP_IOMUXC_SD2_CMD__USDHC2_CMD		0x1d4
			MX8MP_IOMUXC_SD2_DATA0__USDHC2_DATA0		0x1d4
			MX8MP_IOMUXC_SD2_DATA1__USDHC2_DATA1		0x1d4
			MX8MP_IOMUXC_SD2_DATA2__USDHC2_DATA2		0x1d4
			MX8MP_IOMUXC_SD2_DATA3__USDHC2_DATA3		0x1d4
			MX8MP_IOMUXC_GPIO1_IO04__USDHC2_VSELECT		0x140
			MX8MP_IOMUXC_SD2_CD_B__USDHC2_CD_B		0x140
		>;
	};

	usdhc2_200mhz_pins: pinctrl-usdhc2-200mhz-grp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_CLK__USDHC2_CLK		0x196
			MX8MP_IOMUXC_SD2_CMD__USDHC2_CMD		0x1d6
			MX8MP_IOMUXC_SD2_DATA0__USDHC2_DATA0		0x1d6
			MX8MP_IOMUXC_SD2_DATA1__USDHC2_DATA1		0x1d6
			MX8MP_IOMUXC_SD2_DATA2__USDHC2_DATA2		0x1d6
			MX8MP_IOMUXC_SD2_DATA3__USDHC2_DATA3		0x1d6
			MX8MP_IOMUXC_GPIO1_IO04__USDHC2_VSELECT		0x140
			MX8MP_IOMUXC_SD2_CD_B__USDHC2_CD_B		0x140
		>;
	};

	vbus1_pins: pinctrl-vbus-1-grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO14__GPIO1_IO14		0x20
		>;
	};

	vbus2_pins: pinctrl-vbus-2-grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO15__GPIO1_IO15		0x20
		>;
	};

	vmmc_pins: pinctrl-vmmc-grp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_RESET_B__GPIO2_IO19		0x41
		>;
	};

	vmpcie_pins: pinctrl-vmpcie-grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO10__GPIO1_IO10		0x0
		>;
	};
};

&phy0 {
	leds {
		#address-cells = <1>;
		#size-cells = <0>;

		/* ADIN1300 LED_0 pin */
		led@0 {
			reg = <0>;
			color = <LED_COLOR_ID_ORANGE>;
			function = LED_FUNCTION_LAN;
			default-state = "keep";
		};

		/* ADIN1300 LINK_ST pin */
		led@1 {
			reg = <1>;
			color = <LED_COLOR_ID_GREEN>;
			function = LED_FUNCTION_LAN;
			default-state = "keep";
		};
	};
};

&snvs_pwrkey {
	status = "okay";
};

/* mikrobus uart */
&uart3 {
	status = "okay";
};

&usb3_phy0 {
	fsl,phy-tx-preemp-amp-tune-microamp = <1200>;
	vbus-supply = <&vbus2>;
	status = "okay";
};

&usb3_0 {
	status = "okay";
};

&usb3_phy1 {
	vbus-supply = <&vbus1>;
	status = "okay";
};

&usb3_1 {
	status = "okay";
};

&usb_dwc3_0 {
	dr_mode = "host";
};

&usb_dwc3_1 {
	dr_mode = "host";
	#address-cells = <1>;
	#size-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&usb_hub_pins>;

	hub_2_0: hub@1 {
		compatible = "usb4b4,6502", "usb4b4,6506";
		reg = <1>;
		peer-hub = <&hub_3_0>;
		reset-gpios = <&gpio1 11 GPIO_ACTIVE_LOW>;
		vdd-supply = <&v_1_2>;
		vdd2-supply = <&v_3_3>;
	};

	hub_3_0: hub@2 {
		compatible = "usb4b4,6500", "usb4b4,6504";
		reg = <2>;
		peer-hub = <&hub_2_0>;
		reset-gpios = <&gpio1 11 GPIO_ACTIVE_LOW>;
		vdd-supply = <&v_1_2>;
		vdd2-supply = <&v_3_3>;
	};
};

&usdhc2 {
	pinctrl-names = "default", "state_100mhz", "state_200mhz";
	pinctrl-0 = <&usdhc2_pins>;
	pinctrl-1 = <&usdhc2_100mhz_pins>;
	pinctrl-2 = <&usdhc2_200mhz_pins>;
	vmmc-supply = <&vmmc>;
	bus-width = <4>;
	cap-power-off-card;
	full-pwr-cycle;
	status = "okay";
};
